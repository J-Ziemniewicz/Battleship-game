<!DOCTYPE html>
<html>
  <head>
    <title>WebSockets Hello World</title>
    <meta charset="utf-8" />
    <style type="text/css">
      body {
        text-align: center;
        min-width: 500px;
      }
    </style>
    <script src="http://code.jquery.com/jquery.min.js"></script>
    <script>
      // log function
      log = function (data) {
        $('div#terminal').prepend('</br>' + data);
        console.log(data);
      };

      $(document).ready(function () {
        $('div#message_details').hide();

        var ws;

        $('#open').click(function (evt) {
          evt.preventDefault();

          var host = $('#host').val();
          var port = $('#port').val();
          var uri = $('#uri').val();

          // create websocket instance
          ws = new WebSocket('ws://' + host + ':' + port + uri);

          // Handle incoming websocket message callback
          ws.onmessage = function (evt) {
            // const reader = new FileReader();
            // reader.addEventListener('loaded',(e)=>{
            //     const text = e.srcElement.result;
            //     console.log(text)            })
            // var x = reader.readAsText(evt.data)
            // var actual = JSON.parse(atob(evt.data))
            // log("Message Received: " +actual)
            // console.log(evt.data);
            // console.log(typeof evt.data);
            // var reader    = new FileReader();
            //     reader.onload  = function() {
            //         uint8Array  = new Uint8Array(this.result);
            //         console.log(BSON.deserialize(uint8Array));
            //     }
            // reader.readAsArrayBuffer(evt.data);

            const reader = new FileReader();

            // This fires after the blob has been read/loaded.
            reader.addEventListener('loadend', e => {
              var text = e.srcElement.result;
              var object = JSON.parse(text);

              console.log(text);
              console.log(object);
            });

            reader.readAsText(evt.data);

            // Start reading the blob as text.
            // var object = JSON.parse();
            // console.log(text);
            // alert('message received: ' + evt.data);
          };

          // Close Websocket callback
          ws.onclose = function (evt) {
            log('***Connection Closed***');
            alert('Connection close');
            $('#host').css('background', '#ff0000');
            $('#port').css('background', '#ff0000');
            $('#uri').css('background', '#ff0000');
            $('div#message_details').empty();
          };

          // Open Websocket callback
          ws.onopen = function (evt) {
            $('#host').css('background', '#00ff00');
            $('#port').css('background', '#00ff00');
            $('#uri').css('background', '#00ff00');
            $('div#message_details').show();
            log('***Connection Opened***');
          };
        });

        // Send websocket message function
        $('#send').click(function (evt) {
          log('Sending Message: ' + $('#message').val());
          var jsonTmp = {
            type: 'klient',
            ship1: [
              [1, 2],
              [2, 3],
            ],
          };
          var jsonStr = JSON.stringify(jsonTmp);
          var blob = new Blob([jsonStr], { type: 'application/json' });
          // var tempJSON = {"msg":$("message").val()};
          // var objJsonStr = JSON.stringify(tempJSON);
          // ws.send(Buffer.from(objJsonStr).toString("base64"));
          ws.send(blob);
        });
      });
    </script>
  </head>

  <body>
    <h1>WebSockets Hello World</h1>
    <div id="connection_details">
      <label for="host">host:</label>
      <input
        type="text"
        id="host"
        value="localhost"
        style="background: #ff0000;"
      /><br />
      <label for="port">port:</label>
      <input
        type="text"
        id="port"
        value="8888"
        style="background: #ff0000;"
      /><br />
      <label for="uri">uri:</label>
      <input
        type="text"
        id="uri"
        value="/ws"
        style="background: #ff0000;"
      /><br />
      <input type="submit" id="open" value="open" />
    </div>
    <div id="message_details">
      <br /><br />
      <label for="message">message:</label>
      <input type="text" id="message" value="Hello World!" /><br />
      <input type="submit" id="send" value="send" />
    </div>
    <div id="terminal"></div>
  </body>
</html>
